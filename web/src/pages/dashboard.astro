---
import Alert from "../components/Alert.astro";
import Button from "../components/Button.astro";
import Card from "../components/Card.astro";
import CardTitle from "../components/CardTitle.astro";
import Center from "../components/Center.astro";
import PasswordBox from "../components/PasswordBox.astro";
import TextBox from "../components/TextBox.astro";
import Title from "../components/Title.astro";
import Layout from "../layouts/Layout.astro";
---

<Layout title="Dashboard - Ecam">
  <Center>
    <Title>Dashboard</Title>
    <Card>
      <CardTitle>WiFi</CardTitle>
      <div class="flex text-black dark:text-white">
        Status:&nbsp;<div id="wifi-status"></div>
      </div>
      <form class="space-y-5" id="wifi-form">
        <TextBox type="text" id="ssid" name="ssid" placeholder="SSID" />
        <PasswordBox />
        <Button id="save-btn">Save</Button>
      </form>
      <Alert type="success" id="alert-success">Success</Alert>
      <Alert type="error" id="alert-error">Error</Alert>
    </Card>
  </Center>
</Layout>

<script>
  const wifiForm = document.getElementById("wifi-form") as HTMLFormElement;
  const ssid = document.getElementById("ssid") as HTMLInputElement;
  const password = document.getElementById("password") as HTMLInputElement;
  const successAlert = document.getElementById(
    "alert-success"
  ) as HTMLDivElement;
  const errorAlert = document.getElementById("alert-error") as HTMLDivElement;

  successAlert.hidden = true;
  errorAlert.hidden = true;

  const sendSuccessAlert = (msg: string) => {
    successAlert.innerText = msg;
    successAlert.hidden = false;
  };

  const sendErrorAlert = (msg: string) => {
    errorAlert.innerText = msg;
    errorAlert.hidden = false;
  };

  fetch("/api/wifi")
    .then((d) => d.json())
    .then((data) => {
      ssid.value = data.ssid;
      password.value = data.pw;
    })
    .catch((e) => {
      console.error(e);
      sendErrorAlert("Failed to fetch current SSID and Password");
    });

  wifiForm.addEventListener("submit", (e) => {
    e.preventDefault();
    const params = new URLSearchParams({
      ssid: ssid.value,
      pw: password.value,
    });
    fetch(`/api/wifi?${params}`, {
      method: "POST",
    })
      .then((d) => d.text())
      .then((d) => {
        sendSuccessAlert("Successfully set WiFi settings");
      })
      .catch((e) => {
        console.error(e);
        sendErrorAlert("Failed to set WiFi settings");
      });
    console.log("set wifi");
  });

  let isOutOfFocus = false;
  window.onblur = (e) => {
    isOutOfFocus = true;
  }
  window.onfocus = (e) => {
    isOutOfFocus = false;
  }

  const wifiStatusDiv = document.getElementById(
    "wifi-status"
  ) as HTMLDivElement;
  let wifiStatus = "N/A";
  setInterval(() => {
    if (isOutOfFocus) return;
    fetch("/api/wifi_status")
      .then((d) => d.text())
      .then((data) => {
        switch (parseInt(data)) {
          case 255:
            wifiStatus = "No Shield";
            break;
          case 0:
            wifiStatus = "Connecting";
            break;
          case 1:
            wifiStatus = "No SSID Available";
            break;
          case 2:
            wifiStatus = "Scan Completed";
            break;
          case 3:
            wifiStatus = "Connected";
            break;
          case 4:
            wifiStatus = "Connect Failed";
            break;
          case 5:
            wifiStatus = "Connection Lost";
            break;
          case 6:
            wifiStatus = "Disconnected";
            break;
          default:
            wifiStatus = "Error Fetching Status";
            break;
        }
        wifiStatusDiv.innerText = wifiStatus;
      })
      .catch((e) => {
        console.error(e);
        wifiStatusDiv.innerText = "Error Fetching Status";
      });
  }, 1000);
</script>
